<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameSage</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
       <h1>Welcome to GameSage</h1>
    </header>
    
    <main class= "darkmode">
        <div class="content-wrapper">
            <div class="sidebar">
                <!-- Personal Preference Section -->
                <section class="preference-section">
                    <h2>Personal Preference:</h2>
                    <textarea id="preferenceInput" placeholder="Describe your ideal game experience..."></textarea>
                </section>
                <!-- Random Recommendation -->
                <section class="recommendation-section">
                    <h2>Recommend by Genre:</h2>
                    
                    <div class="genre-selection">
                        <div class="select-container">
                            <select id="primaryGenre">
                                <option value="" disabled selected>Select</option>
                                <option value="action">Action</option>
                                <option value="adventure">Adventure</option>
                                <option value="rpg">RPG</option>
                                <option value="strategy">Strategy</option>
                                <option value="simulation">Simulation</option>
                                <option value="sports">Sports</option>
                                <option value="racing">Racing</option>
                                <option value="puzzle">Puzzle</option>c
                                <option value="multiplayer">Multiplayer</option>
                                <option value="singleplayer">Singleplayer</option>
                                <option value="indie">Indie</option>
                                <option value="aaa">AAA</option>
                                <option value="casual">Casual</option>
                                <option value="competitive">Competitive</option>
                                <option value="open-world">Open World</option>
                                <option value="story-rich">Story-Rich</option>
                            </select>
                            <select id="secondaryGenre">
                                <option value="" disabled selected>Select</option>
                                <option value="action">Action</option>
                                <option value="adventure">Adventure</option>
                                <option value="rpg">RPG</option>
                                <option value="strategy">Strategy</option>
                                <option value="simulation">Simulation</option>
                                <option value="sports">Sports</option>
                                <option value="racing">Racing</option>
                                <option value="puzzle">Puzzle</option>c
                                <option value="multiplayer">Multiplayer</option>
                                <option value="singleplayer">Singleplayer</option>
                                <option value="indie">Indie</option>
                                <option value="aaa">AAA</option>
                                <option value="casual">Casual</option>
                                <option value="competitive">Competitive</option>
                                <option value="open-world">Open World</option>
                                <option value="story-rich">Story-Rich</option>
                            </select>
                        </div>
                        
                        <button onclick="getRecommendation()">Random Recommendation</button>
                    </div>
                </section>
            </div>
            
            <!-- Chat Container and Contents -->
            <div class="chat-container">
                <div class="chat-messages" id="chatWindow">
            <!-- Chat History should be here -->
                </div>
                
                <div class="input-area">
                    <input type="text" id="chatInput" placeholder="What kind of game are you looking for?">
                    <button class="send-button" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 GameSage</p>
    </footer>

    <script>
        // Chat functionality
        async function sendMessage() {
            // Get input fields and chat window elements
            let inputField = document.getElementById("chatInput");
            let preferenceField = document.getElementById("preferenceInput");
            let chatWindow = document.getElementById("chatWindow");
            
            // Fetch prompt and preference
            const prompt = inputField.value.trim();
            const preference = preferenceField.value.trim();
            
            // Ignore if no prompt
            if (!prompt) return;

            // Add user's message to chat
            chatWindow.innerHTML += `<strong>You:</strong><br><div class="user-message">${prompt}</div>`;
            inputField.value = "";
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Add "Thinking..." placeholder and keep reference
            const thinkingId = `thinking-${Date.now()}`;
            chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message" id="${thinkingId}">Thinking...</div>`;

            try {
                // Fetch a response from Python backend
                const response = await fetch("/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ preference, prompt })
                });
                
                // Get data from response
                const data = await response.json();

                // Remove the "Thinking..." message
                const thinkingMessage = document.getElementById(thinkingId);
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }
                
                // If successful send response
                if (data.success) {
                    chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message"><b>${data.game_name}</b><br><br>${data.reason}</div>`;
                    chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message">Here are some reviews for the game:</div>`;

                    data.reviews.forEach((review, i) => {
                        chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message">${i + 1}. ${review}</div>`;
                    });

                    chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message">${data.follow_up}</div>`;
                } else {
                    // Not successful, request new prompt
                    chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message">Something went wrong, please try again with a different prompt...</div>`;
                }

                // Automatically scroll chat window
                chatWindow.scrollTop = chatWindow.scrollHeight;

            } catch (error) {
                // Something went wrong when trying to fetch the response from the Python backend
                console.error("Error contacting server:", error);

                // Clean up "Thinking..." message if still present
                const thinkingMessage = document.getElementById(thinkingId);
                if (thinkingMessage) {
                    thinkingMessage.remove();
                }

                chatWindow.innerHTML += `<strong>GameSage:</strong><br><div class="ai-message">Something went wrong while contacting the server.</div>`;
            }
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        // Random Recommendation functionality
        function getRecommendation() {
            document.getElementById("recommendationText").innerText = "Recommendation";
        }
    </script>
</body>
</html>
